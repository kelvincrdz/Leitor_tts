<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor EPUB com TTS</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        // Desabilitar classes de cores que podem conflitar
        theme: {
          extend: {
            colors: {
              // Manter apenas as cores que n√£o conflitam
            }
          }
        }
      }
    </script>
    <!-- CSS personalizado - carregado depois para ter prioridade -->
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="dark bg-gray-900 text-gray-100 min-h-screen">
    <div class="w-full min-h-screen flex flex-col">
        <header class="py-8 px-6 bg-gray-800/50 backdrop-blur-sm">
            <h1 class="text-4xl md:text-6xl lg:text-7xl font-extrabold text-center tracking-tight text-indigo-300 drop-shadow-lg">Leitor EPUB com TTS</h1>
        </header>
        
        <!-- TELA DE BOAS-VINDAS -->
        <div id="welcomeScreen" class="flex-1 flex flex-col items-center justify-center p-8">
            <div class="bg-gray-800 rounded-3xl shadow-2xl p-12 flex flex-col gap-8 items-center w-full max-w-2xl">
                <div class="flex flex-col gap-6 w-full">
                    <button id="btnResumeEpub" class="btn btn-secondary w-full text-xl py-4 flex items-center justify-center gap-3">
                        <span class="text-2xl">‚è©</span>
                        <span>Retomar Leitura Anterior</span>
                    </button>
                    <div class="text-center text-gray-400 text-sm">ou</div>
                    <button id="btnLoadEpub" class="btn btn-primary w-full text-xl py-4 flex items-center justify-center gap-3">
                        <span class="text-2xl">üìö</span>
                        <span>Carregar Novo EPUB</span>
                    </button>
                </div>
                <input type="file" id="fileInput" accept=".epub" class="hidden" />
                <p class="text-gray-400 text-center text-sm mt-4">
                    Suporte completo para navega√ß√£o, s√≠ntese de voz e marcadores
                </p>
            </div>
        </div>
        
        <!-- TELA PRINCIPAL (aparece s√≥ ap√≥s EPUB carregado) -->
        <div id="mainScreen" class="hidden flex-1 flex flex-col overflow-y-auto">
            <div class="flex flex-1 gap-3 p-4 min-h-0">
                <!-- Painel lateral -->
                <aside class="w-72 flex-shrink-0 flex flex-col gap-3">
                    <div class="bg-gray-900 rounded-2xl shadow-lg p-3 flex flex-col gap-2 flex-shrink-0">
                        <h2 class="text-lg font-semibold text-indigo-400 mb-2">Controles de Voz</h2>
                        <div class="flex items-center gap-2 mb-2">
                            <label class="w-20 text-gray-300 text-xs">Velocidade:</label>
                            <input type="range" class="slider flex-1" id="speedSlider" min="50" max="300" value="220" />
                            <span class="value-display w-10 text-indigo-400 text-xs" id="speedValue">220</span>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            <label class="w-20 text-gray-300 text-xs">Tom:</label>
                            <input type="range" class="slider flex-1" id="pitchSlider" min="50" max="200" value="109" />
                            <span class="value-display w-10 text-indigo-400 text-xs" id="pitchValue">109</span>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            <label class="w-20 text-gray-300 text-xs">Volume:</label>
                            <input type="range" class="slider flex-1" id="volumeSlider" min="0" max="100" value="80" />
                            <span class="value-display w-10 text-indigo-400 text-xs" id="volumeValue">80</span>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            <label class="w-20 text-gray-300 text-xs">Voz:</label>
                            <select id="voiceSelect" class="flex-1 border border-gray-700 bg-gray-900 rounded px-2 py-1 text-gray-100 text-xs"></select>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            <label class="w-20 text-gray-300 text-xs">Pausa:</label>
                            <input type="range" class="slider flex-1" id="pauseDurationSlider" min="0" max="1000" value="30" step="10" />
                            <span class="value-display w-12 text-indigo-400 text-xs" id="pauseDurationValue">30ms</span>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="pauseAfterPunctuation" class="accent-indigo-400" checked />
                            <label for="pauseAfterPunctuation" class="text-gray-300 text-xs">Pausar ap√≥s pontua√ß√£o</label>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            <label class="w-20 text-gray-300 text-xs">Timer:</label>
                            <input type="range" class="slider flex-1" id="timerSlider" min="1" max="240" value="120" />
                            <span class="value-display w-12 text-indigo-400 text-xs" id="timerValue">120min</span>
                        </div>
                        <button class="btn btn-secondary mt-auto mb-2 text-xs py-1" id="resetDefaults">Restaurar Padr√£o</button>
                        <button class="btn btn-primary w-full text-xs py-1" onclick="_func_testVoice()">üé§ Testar Voz</button>
                    </div>
                    
                    <div class="bg-gray-800 rounded-2xl shadow-lg p-3 flex flex-col gap-2 flex-shrink-0">
                        <h2 class="text-lg font-semibold text-indigo-400 mb-2">Leitura</h2>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button class="btn btn-success text-xs py-1" id="playBtn">‚ñ∂Ô∏è Play</button>
                            <button class="btn btn-danger text-xs py-1" id="pauseBtn">‚è∏Ô∏è Pause</button>
                            <button class="btn btn-secondary text-xs py-1" id="prevFragmentBtn">‚¨ÜÔ∏è Anterior</button>
                            <button class="btn btn-secondary text-xs py-1" id="nextFragmentBtn">‚¨áÔ∏è Pr√≥ximo</button>
                        </div>
                        <button class="btn btn-primary w-full text-xs py-1" id="startFromHereBtn">üìç Come√ßar a ler daqui</button>
                        <button class="btn btn-primary w-full text-xs py-1" id="markStartBtn">üìç Marcar In√≠cio</button>
                        
                        <!-- Controles de Timer Avan√ßado -->
                        <div class="border-t border-gray-700 pt-2 mt-2">
                            <h3 class="text-sm font-semibold text-indigo-400 mb-1">‚è±Ô∏è Timer Avan√ßado</h3>
                            <div class="grid grid-cols-2 gap-1 mb-1">
                                <button class="btn btn-secondary text-xs py-1" onclick="window.app.toggleTimerMode()" id="timerModeBtn">üìñ Modo Leitura</button>
                                <button class="btn btn-secondary text-xs py-1" onclick="window.app.pauseResumeTimer()" id="timerPauseBtn">‚è∏Ô∏è Pausar</button>
                            </div>
                            <div class="grid grid-cols-2 gap-1 mb-1">
                                <button class="btn btn-warning text-xs py-1" onclick="window.app.startCountdownTimer(parseInt(document.getElementById('timerSlider').value))">‚è∞ Iniciar Contagem</button>
                                <button class="btn btn-danger text-xs py-1" onclick="window.app.resetTimer()">üîÑ Resetar</button>
                            </div>
                        </div>
                        
                        <div class="timer-display text-center text-indigo-400 font-mono text-lg bg-gray-900 rounded p-2" id="timerDisplay">00:00:00</div>
                        <div class="text-xs text-gray-400 text-center">Status: <span id="statusText">Pronto</span> <span class="status-indicator status-ready" id="statusIndicator"></span></div>
                    </div>
                    
                    <div class="bg-gray-800 rounded-2xl shadow-lg p-3 flex flex-col gap-2 flex-shrink-0">
                        <h2 class="text-lg font-semibold text-indigo-400 mb-2">Marcadores</h2>
                        <button class="btn btn-primary w-full text-xs py-1" id="addBookmarkBtn">+ Adicionar Marcador</button>
                        <button class="btn btn-secondary w-full text-xs py-1" onclick="_func_showStats()">üìä Estat√≠sticas</button>
                        <div class="bookmarks-list max-h-32 overflow-y-auto bg-gray-900 rounded p-2 text-xs" id="bookmarksList"></div>
                    </div>
                </aside>
                
                <!-- Campo de acompanhamento da leitura -->
                <div class="flex-1 flex flex-col gap-4 min-w-0">
                    <!-- √Årea de rolagem principal -->
                    <div class="bg-gray-800 rounded-2xl shadow-lg p-4 flex flex-col gap-4">
                        <div class="flex items-center gap-4 mb-3 flex-shrink-0">
                            <span id="sliderPageLabel" class="text-indigo-400 font-semibold min-w-[120px] text-lg">P√°gina 1 de 1</span>
                            <input type="range" id="chapterSlider" min="1" max="1" value="1" class="flex-1 accent-indigo-400 h-3" />
                        </div>
                        <div class="flex items-center justify-between gap-4 mb-3 flex-shrink-0">
                            <button class="btn btn-secondary px-6 py-2" id="prevPage">‚Üê Anterior</button>
                            <span class="page-info text-indigo-400 font-semibold text-lg" id="pageInfo">P√°gina 1 de 1</span>
                            <button class="btn btn-secondary px-6 py-2" id="nextPage">Pr√≥xima ‚Üí</button>
                        </div>
                        <div class="w-full h-3 bg-gray-700 rounded overflow-hidden flex-shrink-0">
                            <div class="bg-indigo-400 h-3 transition-all" id="progressFill" style="width:0%"></div>
                        </div>
                        
                        <!-- Indicador de posi√ß√£o de rolagem -->
                        <div class="flex items-center justify-between text-xs text-gray-400 flex-shrink-0">
                            <span id="scrollPosition">Posi√ß√£o: 0%</span>
                            <span id="scrollInfo">Linha 1 de 1</span>
                        </div>
                        
                        <!-- Controles de rolagem -->
                        <div class="flex items-center justify-center gap-2 mb-2 flex-shrink-0">
                            <button class="btn btn-secondary text-xs py-1 px-3" onclick="_func_scrollToTop()" title="Ir para o topo">
                                ‚¨ÜÔ∏è Topo
                            </button>
                            <button class="btn btn-secondary text-xs py-1 px-3" onclick="_func_scrollUp()" title="Rolar para cima">
                                ‚¨ÜÔ∏è Cima
                            </button>
                            <button class="btn btn-secondary text-xs py-1 px-3" onclick="_func_scrollDown()" title="Rolar para baixo">
                                ‚¨áÔ∏è Baixo
                            </button>
                            <button class="btn btn-secondary text-xs py-1 px-3" onclick="_func_scrollToBottom()" title="Ir para o final">
                                ‚¨áÔ∏è Final
                            </button>
                        </div>
                        
                        <div class="epub-viewer overflow-y-auto bg-gray-900 rounded-lg p-4 text-lg leading-relaxed custom-scrollbar" id="epubViewer" style="min-height: 400px; max-height: 600px;">
                            <div class="text-center text-gray-500 py-12">
                                <h3 class="text-xl font-medium">Carregue um arquivo EPUB para come√ßar</h3>
                                <p>Suporte completo para navega√ß√£o e s√≠ntese de voz</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campo de pesquisa fixo na parte inferior -->
                    <div class="flex-shrink-0 bg-gray-800 rounded-2xl shadow-lg p-4 search-container-fixed">
                        <div class="flex items-center gap-3">
                            <div class="flex-1">
                                <input type="text" id="searchInput" placeholder="Buscar no livro todo..." class="w-full border border-gray-700 bg-gray-900 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-400 text-gray-100 text-lg search-input-enhanced" />
                            </div>
                            <button class="btn btn-primary px-4 py-3 search-btn" onclick="_func_performSearch()" title="Buscar">
                                üîç Buscar
                            </button>
                            <button class="btn btn-secondary px-4 py-3 clear-btn" onclick="_func_clearSearch()" title="Limpar busca">
                                ‚ùå Limpar
                            </button>
                        </div>
                        <!-- Resultados da busca -->
                        <div id="searchResults" class="mt-3 hidden search-results">
                            <div class="text-sm text-gray-400 mb-2">Resultados da busca:</div>
                            <div id="searchResultsList" class="max-h-32 overflow-y-auto bg-gray-900 rounded p-2 text-sm"></div>
                        </div>
                        <!-- Navega√ß√£o direta -->
                        <div class="flex items-center gap-2 mt-4">
                            <input type="number" id="gotoChapter" min="1" placeholder="Cap√≠tulo" class="w-20 px-2 py-1 rounded bg-gray-900 border border-gray-700 text-gray-100 text-sm" />
                            <input type="number" id="gotoSentence" min="1" placeholder="Senten√ßa" class="w-24 px-2 py-1 rounded bg-gray-900 border border-gray-700 text-gray-100 text-sm" />
                            <button class="btn btn-primary px-2 py-1 text-xs" onclick="_func_gotoChapterSentence()">Ir</button>
                            <input type="number" id="gotoPage" min="1" placeholder="P√°gina" class="w-20 px-2 py-1 rounded bg-gray-900 border border-gray-700 text-gray-100 text-sm ml-4" />
                            <button class="btn btn-primary px-2 py-1 text-xs" onclick="_func_gotoPage()">Ir p√°g</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal de estat√≠sticas e atalhos -->
    <div id="statsModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full relative">
            <button onclick="document.getElementById('statsModal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-white text-xl">&times;</button>
            <h2 class="text-lg font-bold text-indigo-400 mb-2">üìä Estat√≠sticas de Leitura</h2>
            <div id="statsContent" class="mb-4 text-gray-200 text-sm">
                <!-- Conte√∫do din√¢mico das estat√≠sticas -->
            </div>
            <h3 class="text-base font-semibold text-indigo-400 mb-2 mt-4">‚å®Ô∏è Atalhos do Teclado</h3>
            <ul class="text-gray-300 text-sm list-disc pl-5">
                <li><b>Espa√ßo</b> - Play/Pause</li>
                <li><b>‚Üí</b> - Pr√≥ximo cap√≠tulo</li>
                <li><b>‚Üê</b> - Cap√≠tulo anterior</li>
                <li><b>Ctrl+F</b> - Buscar</li>
                <li><b>Ctrl+B</b> - Adicionar marcador</li>
                <li><b>Esc</b> - Parar leitura</li>
            </ul>
            <h3 class="text-base font-semibold text-indigo-400 mb-2 mt-4">üåê Google Translate TTS</h3>
            <div class="text-gray-300 text-sm">
                <p>O leitor usa o Google Translate TTS gratuito:</p>
                <ul class="list-disc pl-5 mt-2">
                    <li>Vozes de alta qualidade do Google</li>
                    <li>Suporte a m√∫ltiplos idiomas</li>
                    <li>Funciona em qualquer navegador</li>
                    <li>Use o bot√£o "üé§ Testar Voz" para verificar</li>
                    <li>Requer conex√£o com a internet</li>
                </ul>
            </div>
        </div>
    </div>
    <script src="js/app.js"></script>
    <script>
      // L√≥gica de exibi√ß√£o das telas
      function _func_showScreen(var_bool_main) {
        document.getElementById('welcomeScreen').classList.toggle('hidden', var_bool_main);
        document.getElementById('mainScreen').classList.toggle('hidden', !var_bool_main);
        if(var_bool_main) localStorage.setItem('epubReaderLastScreen', 'main');
        else localStorage.setItem('epubReaderLastScreen', 'welcome');
      }

      // Fun√ß√£o para retomar leitura anterior
      function _func_resumePreviousReading() {
        if (window.app && window.app.loadReadingState()) {
          _func_showScreen(true);
          // Atualizar interface ap√≥s carregar estado
          setTimeout(() => {
            if (typeof window.app._updateSlider === 'function') {
              window.app._updateSlider();
            }
            if (typeof window.app._updateStartBtnState === 'function') {
              window.app._updateStartBtnState();
            }
          }, 100);
        } else {
          alert('Nenhuma leitura anterior encontrada para retomar.');
        }
      }

      // Ao carregar, sempre mostrar a tela de boas-vindas
      window.addEventListener('DOMContentLoaded', () => {
        _func_showScreen(false);
      });

      // Configurar bot√µes da tela de boas-vindas
      document.getElementById('btnLoadEpub').onclick = () => document.getElementById('fileInput').click();
      document.getElementById('btnResumeEpub').onclick = _func_resumePreviousReading;

      // Aguardar a inicializa√ß√£o da classe para configurar o fileInput
      window.addEventListener('DOMContentLoaded', () => {
        // Aguardar um pouco para garantir que a classe foi inicializada
        setTimeout(() => {
          if (window.app) {
            // Remover event listener conflitante do fileInput
            const var_el_fileInput = document.getElementById('fileInput');
            if (var_el_fileInput) {
              // Remover listeners antigos
              const var_el_newFileInput = var_el_fileInput.cloneNode(true);
              var_el_fileInput.parentNode.replaceChild(var_el_newFileInput, var_el_fileInput);
              
              // Adicionar listener que chama a classe e mostra a tela principal
              var_el_newFileInput.addEventListener('change', (var_obj_e) => {
                if (var_obj_e.target.files[0]) {
                  window.app.loadEPUB(var_obj_e.target.files[0]);
                  _func_showScreen(true);
                }
              });
            }
          }
        }, 100);
      });

      // Fun√ß√£o para mostrar estat√≠sticas
      function _func_showStats() {
        if (window.app && typeof window.app.getReadingStats === 'function') {
          const var_obj_stats = window.app.getReadingStats();
          if (var_obj_stats) {
            document.getElementById('statsContent').innerHTML = `
              <b>Total de cap√≠tulos:</b> ${var_obj_stats.totalChapters}<br>
              <b>Total de palavras:</b> ${var_obj_stats.totalWords.toLocaleString()}<br>
              <b>Total de caracteres:</b> ${var_obj_stats.totalCharacters.toLocaleString()}<br>
              <b>Cap√≠tulo atual:</b> ${var_obj_stats.currentChapter}<br>
              <b>Progresso:</b> ${var_obj_stats.progress}%<br>
              <b>Tempo de leitura:</b> ${Math.floor(var_obj_stats.readingTime / 60)} min ${var_obj_stats.readingTime % 60} seg<br>
              <b>Marcadores:</b> ${var_obj_stats.bookmarksCount}
            `;
          } else {
            document.getElementById('statsContent').innerHTML = 'Carregue um arquivo EPUB primeiro.';
          }
        }
        document.getElementById('statsModal').classList.remove('hidden');
      }

      // Fun√ß√£o para testar a voz selecionada
      function _func_testVoice() {
        if (window.app && typeof window.app.testCurrentVoice === 'function') {
          window.app.testCurrentVoice();
        } else if (window.app && window.app.googleTTS) {
          // Usar a nova implementa√ß√£o do Google TTS com fallback
          window.app.googleTTS.testVoice();
        } else {
          // Fallback para Google TTS direto
          const var_str_testText = "Ol√°! Esta √© uma voz de teste do leitor EPUB. Se voc√™ consegue ouvir esta mensagem, a s√≠ntese de voz est√° funcionando corretamente.";
          
          // Tentar diferentes URLs do Google TTS
          const var_str_encodedText = encodeURIComponent(var_str_testText);
          const var_arr_ttsUrls = [
            `https://translate.google.com/translate_tts?ie=UTF-8&q=${var_str_encodedText}&tl=pt-BR&client=tw-ob`,
            `https://translate.google.com/translate_tts?ie=UTF-8&q=${var_str_encodedText}&tl=pt-BR&client=tw-ob&total=1&idx=0&textlen=${var_str_testText.length}`,
            `https://translate.google.com/translate_tts?ie=UTF-8&q=${var_str_encodedText}&tl=pt-BR&client=tw-ob&prev=input`
          ];
          
          const var_num_volume = document.getElementById('volumeSlider') ? document.getElementById('volumeSlider').value / 100 : 0.8;
          
          function _func_tryTTS(var_arr_urls, var_num_index) {
            if (var_num_index >= var_arr_urls.length) {
              console.error('‚ùå Todas as tentativas do Google TTS falharam');
              // Fallback para TTS nativo
              if ('speechSynthesis' in window) {
                const var_obj_utterance = new SpeechSynthesisUtterance(var_str_testText);
                var_obj_utterance.lang = 'pt-BR';
                var_obj_utterance.volume = var_num_volume;
                speechSynthesis.speak(var_obj_utterance);
                console.log('üîÑ Usando TTS nativo como fallback');
              } else {
                alert('Erro ao testar voz. Verifique sua conex√£o com a internet.');
              }
              return;
            }
            
            const var_obj_audio = new Audio(var_arr_urls[var_num_index]);
            var_obj_audio.volume = var_num_volume;
            
            var_obj_audio.onerror = (var_obj_error) => {
              console.error(`‚ùå Erro no teste de voz (tentativa ${var_num_index + 1}):`, var_obj_error);
              setTimeout(() => _func_tryTTS(var_arr_urls, var_num_index + 1), 100);
            };
            
            var_obj_audio.play().catch(var_obj_error => {
              console.error(`‚ùå Erro ao iniciar teste de voz (tentativa ${var_num_index + 1}):`, var_obj_error);
              setTimeout(() => _func_tryTTS(var_arr_urls, var_num_index + 1), 100);
            });
          }
          
          _func_tryTTS(var_arr_ttsUrls, 0);
        }
      }

      // Fun√ß√µes de controle de rolagem
      function _func_scrollToTop() {
        const var_el_epubViewer = document.getElementById('epubViewer');
        if (var_el_epubViewer) {
          var_el_epubViewer.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
          _func_showScrollIndicator('Topo');
        }
      }

      function _func_scrollUp() {
        const var_el_epubViewer = document.getElementById('epubViewer');
        if (var_el_epubViewer) {
          const var_num_currentScroll = var_el_epubViewer.scrollTop;
          const var_num_scrollAmount = Math.max(100, var_el_epubViewer.clientHeight * 0.3);
          var_el_epubViewer.scrollTo({
            top: Math.max(0, var_num_currentScroll - var_num_scrollAmount),
            behavior: 'smooth'
          });
          _func_showScrollIndicator('Cima');
        }
      }

      function _func_scrollDown() {
        const var_el_epubViewer = document.getElementById('epubViewer');
        if (var_el_epubViewer) {
          const var_num_currentScroll = var_el_epubViewer.scrollTop;
          const var_num_maxScroll = var_el_epubViewer.scrollHeight - var_el_epubViewer.clientHeight;
          const var_num_scrollAmount = Math.max(100, var_el_epubViewer.clientHeight * 0.3);
          var_el_epubViewer.scrollTo({
            top: Math.min(var_num_maxScroll, var_num_currentScroll + var_num_scrollAmount),
            behavior: 'smooth'
          });
          _func_showScrollIndicator('Baixo');
        }
      }

      function _func_scrollToBottom() {
        const var_el_epubViewer = document.getElementById('epubViewer');
        if (var_el_epubViewer) {
          var_el_epubViewer.scrollTo({
            top: var_el_epubViewer.scrollHeight,
            behavior: 'smooth'
          });
          _func_showScrollIndicator('Final');
        }
      }

      // Fun√ß√£o para mostrar indicador de rolagem
      function _func_showScrollIndicator(var_str_action) {
        // Criar ou atualizar indicador
        let var_el_indicator = document.getElementById('scrollIndicator');
        if (!var_el_indicator) {
          var_el_indicator = document.createElement('div');
          var_el_indicator.id = 'scrollIndicator';
          var_el_indicator.className = 'scroll-indicator';
          document.body.appendChild(var_el_indicator);
        }
        
        var_el_indicator.textContent = `Rolando: ${var_str_action}`;
        var_el_indicator.classList.add('show');
        
        // Esconder ap√≥s 1.5 segundos
        setTimeout(() => {
          var_el_indicator.classList.remove('show');
        }, 1500);
      }

      // Adicionar atalhos de teclado para rolagem
      document.addEventListener('keydown', function(var_obj_e) {
        // S√≥ aplicar se n√£o estiver em um campo de input
        if (var_obj_e.target.tagName === 'INPUT' || var_obj_e.target.tagName === 'TEXTAREA') {
          return;
        }
        
        switch(var_obj_e.key) {
          case 'Home':
            var_obj_e.preventDefault();
            _func_scrollToTop();
            break;
          case 'End':
            var_obj_e.preventDefault();
            _func_scrollToBottom();
            break;
          case 'PageUp':
            var_obj_e.preventDefault();
            _func_scrollUp();
            break;
          case 'PageDown':
            var_obj_e.preventDefault();
            _func_scrollDown();
            break;
        }
      });

      // Adicionar indicador de posi√ß√£o de rolagem
      function _func_updateScrollPosition() {
        const var_el_epubViewer = document.getElementById('epubViewer');
        if (var_el_epubViewer && var_el_epubViewer.scrollHeight > var_el_epubViewer.clientHeight) {
          const var_num_scrollPercent = Math.round((var_el_epubViewer.scrollTop / (var_el_epubViewer.scrollHeight - var_el_epubViewer.clientHeight)) * 100);
          const var_el_progressFill = document.getElementById('progressFill');
          if (var_el_progressFill) {
            var_el_progressFill.style.width = var_num_scrollPercent + '%';
          }
          
          // Atualizar indicador de posi√ß√£o
          const var_el_scrollPosition = document.getElementById('scrollPosition');
          if (var_el_scrollPosition) {
            var_el_scrollPosition.textContent = `Posi√ß√£o: ${var_num_scrollPercent}%`;
          }
          
          // Atualizar informa√ß√£o de linha (aproximada)
          const var_el_scrollInfo = document.getElementById('scrollInfo');
          if (var_el_scrollInfo) {
            const var_num_totalHeight = var_el_epubViewer.scrollHeight;
            const var_num_currentPosition = var_el_epubViewer.scrollTop;
            const var_num_viewportHeight = var_el_epubViewer.clientHeight;
            
            // Calcular linha aproximada baseada na posi√ß√£o
            const var_num_lineHeight = 24; // Altura aproximada de uma linha
            const var_num_currentLine = Math.floor(var_num_currentPosition / var_num_lineHeight) + 1;
            const var_num_totalLines = Math.floor(var_num_totalHeight / var_num_lineHeight);
            
            var_el_scrollInfo.textContent = `Linha ${var_num_currentLine} de ${var_num_totalLines}`;
          }
        }
      }

      // Atualizar posi√ß√£o de rolagem quando o conte√∫do mudar
      const var_el_epubViewer = document.getElementById('epubViewer');
      if (var_el_epubViewer) {
        var_el_epubViewer.addEventListener('scroll', _func_updateScrollPosition);
        
        // Adicionar rolagem suave com a roda do mouse
        var_el_epubViewer.addEventListener('wheel', function(var_obj_e) {
          // Prevenir rolagem padr√£o se Shift estiver pressionado
          if (var_obj_e.shiftKey) {
            var_obj_e.preventDefault();
            const var_num_scrollAmount = var_obj_e.deltaY > 0 ? 100 : -100;
            var_el_epubViewer.scrollBy({
              top: var_num_scrollAmount,
              behavior: 'smooth'
            });
          }
        });
        
        // Adicionar rolagem com teclas de seta
        var_el_epubViewer.addEventListener('keydown', function(var_obj_e) {
          if (var_obj_e.target === var_el_epubViewer) {
            const var_num_scrollAmount = 50;
            switch(var_obj_e.key) {
              case 'ArrowUp':
                var_obj_e.preventDefault();
                var_el_epubViewer.scrollBy({
                  top: -var_num_scrollAmount,
                  behavior: 'smooth'
                });
                break;
              case 'ArrowDown':
                var_obj_e.preventDefault();
                var_el_epubViewer.scrollBy({
                  top: var_num_scrollAmount,
                  behavior: 'smooth'
                });
                break;
            }
          }
        });
      }
      
      // Fun√ß√£o para rolagem autom√°tica durante leitura
      function _func_autoScroll() {
        const var_el_epubViewer = document.getElementById('epubViewer');
        if (var_el_epubViewer && window.app && window.app.isPlaying && !window.app.isPaused) {
          // Rolar automaticamente para a pr√≥xima senten√ßa
          const var_el_highlightedSentence = var_el_epubViewer.querySelector('.sentence.highlight');
          if (var_el_highlightedSentence) {
            var_el_highlightedSentence.scrollIntoView({
              behavior: 'smooth',
              block: 'center'
            });
          }
        }
      }
      
      // Configurar rolagem autom√°tica
      setInterval(_func_autoScroll, 1000);
      
      // Busca reativa ao digitar
      // document.getElementById('searchInput').addEventListener('input', function() {
      //   _func_performSearch(true);
      // });

      // Enter navega para o pr√≥ximo resultado
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          _func_nextSearchResult();
        }
      });

      // Vari√°vel global para controle dos resultados
      let var_arr_lastSearchResults = [];
      let var_num_currentSearchIdx = 0;

      function _func_performSearch(isReactive) {
        const var_el_searchInput = document.getElementById('searchInput');
        const var_str_query = var_el_searchInput.value.trim();
        const var_el_searchResults = document.getElementById('searchResults');
        const var_el_searchResultsList = document.getElementById('searchResultsList');
        
        if (!var_str_query) {
          var_el_searchResultsList.innerHTML = '';
          var_el_searchResults.classList.add('hidden');
          return;
        }
        
        if (window.app && typeof window.app.searchGlobal === 'function') {
          var_arr_lastSearchResults = window.app.searchGlobal(var_str_query);
          var_num_currentSearchIdx = 0;
          if (var_arr_lastSearchResults.length === 0) {
            var_el_searchResultsList.innerHTML = '<div class="text-gray-400">Nenhum resultado encontrado.</div>';
          } else {
            var_el_searchResultsList.innerHTML = var_arr_lastSearchResults.map((r, i) =>
              `<div class='search-result-item mb-2 cursor-pointer hover:bg-indigo-900/40 rounded p-1 ${i===0?'bg-yellow-900/40':''}' onclick='window.app.goToSearchResult(${r.chapter},${r.sentence});_func_highlightSearchResult(${i});'><b>Cap√≠tulo ${r.chapter+1}</b>: ...${r.context}...</div>`
            ).join('');
            // Destacar o primeiro resultado automaticamente
            if (isReactive && var_arr_lastSearchResults.length > 0) {
              window.app.goToSearchResult(var_arr_lastSearchResults[0].chapter, var_arr_lastSearchResults[0].sentence);
              _func_highlightSearchResult(0);
            }
          }
          var_el_searchResults.classList.remove('hidden');
        }
      }

      function _func_highlightSearchResult(idx) {
        var_num_currentSearchIdx = idx;
        // Atualiza o destaque visual na lista
        const items = document.querySelectorAll('.search-result-item');
        items.forEach((el, i) => {
          if (i === idx) el.classList.add('bg-yellow-900/40');
          else el.classList.remove('bg-yellow-900/40');
        });
      }

      function _func_nextSearchResult() {
        if (var_arr_lastSearchResults.length === 0) return;
        var_num_currentSearchIdx = (var_num_currentSearchIdx + 1) % var_arr_lastSearchResults.length;
        const r = var_arr_lastSearchResults[var_num_currentSearchIdx];
        window.app.goToSearchResult(r.chapter, r.sentence);
        _func_highlightSearchResult(var_num_currentSearchIdx);
      }

      function _func_clearSearch() {
        const var_el_searchInput = document.getElementById('searchInput');
        const var_el_searchResults = document.getElementById('searchResults');
        
        var_el_searchInput.value = '';
        var_el_searchResults.classList.add('hidden');
        
        // Limpar highlights de busca
        const var_arr_highlights = document.querySelectorAll('.search-highlight');
        var_arr_highlights.forEach(var_el_highlight => {
          var_el_highlight.classList.remove('search-highlight');
        });
        
        // Focar no campo de busca
        var_el_searchInput.focus();
      }
      
      function _func_gotoChapterSentence() {
        const cap = parseInt(document.getElementById('gotoChapter').value, 10) - 1;
        const sent = parseInt(document.getElementById('gotoSentence').value, 10) - 1;
        if (!isNaN(cap) && cap >= 0 && cap < window.app.chapters.length) {
          window.app.currentChapter = cap;
          if (!isNaN(sent) && sent >= 0) {
            window.app.currentSentenceIndex = sent;
          } else {
            window.app.currentSentenceIndex = 0;
          }
          window.app.displayCurrentChapter();
          window.app.highlightCurrentSentence();
          if (typeof window.app._updateSlider === 'function') window.app._updateSlider();
        }
      }

      function _func_gotoPage() {
        const page = parseInt(document.getElementById('gotoPage').value, 10) - 1;
        const sentencesPerPage = 30; // Defina quantas senten√ßas por p√°gina
        if (!isNaN(page) && page >= 0) {
          let total = 0;
          for (let c = 0; c < window.app.chapters.length; c++) {
            const sentences = window.app.splitIntoSentences(window.app.chapters[c].content);
            if (total + sentences.length > page * sentencesPerPage) {
              const sent = (page * sentencesPerPage) - total;
              window.app.currentChapter = c;
              window.app.currentSentenceIndex = sent;
              window.app.displayCurrentChapter();
              window.app.highlightCurrentSentence();
              if (typeof window.app._updateSlider === 'function') window.app._updateSlider();
              break;
            }
            total += sentences.length;
          }
        }
      }
    </script>
</body>
</html> 